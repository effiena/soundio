<script>
document.addEventListener("DOMContentLoaded", () => {
    const player = document.getElementById("player");
    const titleEl = document.getElementById("current-song");
    const playlistEl = document.getElementById("playlist");
    const genreFilter = document.getElementById("genre-filter");
    const logo = document.getElementById("soundio-logo");

    let playlist = []; // full playlist from backend
    let items = [];    // visible songs after filter
    let index = 0;
    let isPlaying = false;
    let repeat = false
    let audioCtx, analyser, source, dataArray;

function updateTitle(name){
        titleEl.textContent = "ðŸŽ¶ Now Playing: " + name;
    }


function initAudio() {
    if(audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    source = audioCtx.createMediaElementSource(player);
    analyser = audioCtx.createAnalyser();
    source.connect(analyser);
    analyser.connect(audioCtx.destination);
    analyser.fftSize = 256;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    animateVisuals();
}

function animateVisuals() {
    if(!analyser) return;
    requestAnimationFrame(animateVisuals);

    analyser.getByteFrequencyData(dataArray);
    let avg = dataArray.reduce((a,b)=>a+b)/dataArray.length;

    // Logo pulsing
    const logoScale = 0.9 + (avg / 255) * 0.3;
    const logoGlow = (avg / 255) * 15;
    logo.style.transform = `scale(${logoScale})`;
    logo.style.boxShadow = `0 0 ${logoGlow}px rgba(230,194,41,0.8)`;
    logo.style.setProperty('--wave-scale', 1 + (avg / 255) * 0.3);
    logo.style.setProperty('--wave-glow', logoGlow);

    // Now Playing text pulsing
    const textScale = 1 + (avg / 255) * 0.08; // smaller pulse for text
    const textGlow = (avg / 255) * 8;
    titleEl.style.transform = `scale(${textScale})`;
    titleEl.style.textShadow = `0 0 ${textGlow}px rgba(255,255,255,0.8),
                                0 0 ${textGlow/2}px rgba(255,255,0,0.6)`;
}

// Make sure you call initAudio() inside your loadSong function
function loadSongByUrl(url, name){
    if(!url) return;
    initAudio(); // initialize audio and animations

    // Highlight current song
    items.forEach(li=>li.classList.remove("active"));
    const li = items.find(li=>li.dataset.url===url);
    if(li) li.classList.add("active");

    player.src = encodeURI(url);
    player.play();
    isPlaying = true;
    titleEl.textContent = "ðŸŽ¶ Now Playing: " + name;
    index = items.findIndex(li=>li.dataset.url===url);
}


    function renderPlaylist() {
        playlistEl.innerHTML = "";
        const selected = genreFilter.value;
        items = [];

        playlist.forEach(song => {
            if(selected === "all" || song.genre === selected){
                const li = document.createElement("li");
                li.textContent = song.name.replace(/_/g,' ');
                li.dataset.url = song.url;
                li.dataset.genre = song.genre;
                li.addEventListener("click", ()=> loadSongByUrl(song.url, song.name.replace(/_/g,' ')));
                playlistEl.appendChild(li);
                items.push(li);
            }
        });
        index = 0;
    }



    // Buttons
    document.getElementById("play-pause-btn").onclick = ()=> {
        if(!player.src){ if(items[0]) loadSongByUrl(items[0].dataset.url, items[0].textContent); return; }
        if(isPlaying){ player.pause(); this.textContent="â–¶ï¸"; } 
        else{ player.play(); this.textContent="â¸"; }
        isPlaying = !isPlaying;
    };
    document.getElementById("stop-btn").onclick = ()=> { player.pause(); player.currentTime=0; isPlaying=false; };
    document.getElementById("next-btn").onclick = ()=> { index = repeat?index:(index+1)%items.length; loadSongByUrl(items[index].dataset.url, items[index].textContent); };
    document.getElementById("prev-btn").onclick = ()=> { index = (index-1+items.length)%items.length; loadSongByUrl(items[index].dataset.url, items[index].textContent); };
    document.getElementById("shuffle-btn").onclick = ()=>{
        items.sort(()=>Math.random()-0.5);
        renderPlaylist();
        if(items[0]) loadSongByUrl(items[0].dataset.url, items[0].textContent);
    };
    document.getElementById("repeat-btn").onclick = ()=>{ repeat=!repeat; alert("Repeat "+(repeat?"ON":"OFF")); };
    player.addEventListener("ended", ()=> { index = repeat?index:(index+1)%items.length; loadSongByUrl(items[index].dataset.url, items[index].textContent); });

    genreFilter.addEventListener("change", renderPlaylist);

    // Fetch playlist from backend
    fetch("/songs")
        .then(r=>r.json())
        .then(data=>{
            playlist = data; // expect [{name, url, genre}]
            renderPlaylist();
        })
        .catch(e=>console.error("Failed to load songs", e));
});
</script>

<footer style="text-align:center; padding:10px; font-size:14px; color:#555;">
    Â© 2026 Soundio Music App. All rights reserved. <br>
    <a> Created by Asli.Tech</a>
    <a href="/license.txt" target="_blank">SOUNDIO Music App License</a>
</footer>

</body>
</html>
