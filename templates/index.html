<script>
document.addEventListener("DOMContentLoaded", () => {
    const player = document.getElementById("player");
    const titleEl = document.getElementById("current-song");
    const playlistEl = document.getElementById("playlist");
    const genreFilter = document.getElementById("genre-filter");
    const logo = document.getElementById("soundio-logo");

    let playlist = []; // full playlist from backend
    let items = [];    // filtered playlist
    let index = 0;
    let isPlaying = false;
    let repeat = false;
    let audioCtx, analyser, source, dataArray;

    function initAudio() {
        if (audioCtx) return;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        source = audioCtx.createMediaElementSource(player);
        analyser = audioCtx.createAnalyser();
        source.connect(analyser);
        analyser.connect(audioCtx.destination);
        analyser.fftSize = 256;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        animateVisuals();
    }

    function animateVisuals() {
        if(!analyser) return;
        requestAnimationFrame(animateVisuals);
        analyser.getByteFrequencyData(dataArray);
        let avg = dataArray.reduce((a,b)=>a+b)/dataArray.length;

        const logoScale = 0.9 + (avg/255)*0.3;
        const logoGlow = (avg/255)*15;
        logo.style.transform = `scale(${logoScale})`;
        logo.style.boxShadow = `0 0 ${logoGlow}px rgba(230,194,41,0.8)`;
        logo.style.setProperty('--wave-scale', 1 + (avg/255)*0.3);
        logo.style.setProperty('--wave-glow', logoGlow);

        const textScale = 1 + (avg/255)*0.08;
        const textGlow = (avg/255)*8;
        titleEl.style.transform = `scale(${textScale})`;
        titleEl.style.textShadow = `0 0 ${textGlow}px rgba(255,255,255,0.8), 0 0 ${textGlow/2}px rgba(255,255,0,0.6)`;
    }

    function loadSong(i){
        if(!items[i]) return;
        const song = items[i];
        items.forEach(li=>li.classList.remove("active"));
        song.li.classList.add("active");

        initAudio();
        player.src = encodeURI(song.url);
        player.play().catch(()=>{}); // mobile autoplay fix
        titleEl.textContent = "ðŸŽ¶ Now Playing: " + song.name;
        index = i;
        isPlaying = true;
    }

    function renderPlaylist() {
        playlistEl.innerHTML = "";
        const selected = genreFilter.value;
        items = [];

        playlist.forEach((song) => {
            if (selected === "all" || song.genre === selected) {
                const li = document.createElement("li");
                li.textContent = song.name.replace(/_/g,' ');
                li.dataset.url = song.url;
                li.dataset.genre = song.genre;
                li.addEventListener("click", ()=> loadSong(items.length));
                playlistEl.appendChild(li);
                items.push({ ...song, li });
            }
        });

        if(items[0]) loadSong(0);
    }

    // Buttons
    document.getElementById("play-pause-btn").onclick = () => {
        if(!player.src && items[0]) loadSong(0);
        else if(isPlaying){ player.pause(); this.textContent="â–¶ï¸"; }
        else{ player.play().catch(()=>{}); this.textContent="â¸"; }
        isPlaying = !isPlaying;
    };
    document.getElementById("stop-btn").onclick = () => { player.pause(); player.currentTime=0; isPlaying=false; };
    document.getElementById("next-btn").onclick = () => { index = repeat ? index : (index+1)%items.length; loadSong(index); };
    document.getElementById("prev-btn").onclick = () => { index = (index-1+items.length)%items.length; loadSong(index); };
    document.getElementById("shuffle-btn").onclick = () => { items.sort(()=>Math.random()-0.5); renderPlaylist(); };
    document.getElementById("repeat-btn").onclick = () => { repeat = !repeat; alert("Repeat "+(repeat?"ON":"OFF")); };

    player.addEventListener("ended", () => { index = repeat ? index : (index+1)%items.length; loadSong(index); });
    genreFilter.addEventListener("change", renderPlaylist);

    // Fetch songs from backend
    fetch("/songs")
        .then(res => res.json())
        .then(data => { playlist = data; renderPlaylist(); })
        .catch(e => console.error("Failed to load songs", e));
});
</script>

<footer style="text-align:center; padding:10px; font-size:14px; color:#555;">
    Â© 2026 Soundio Music App. All rights reserved. <br>
    <a> Created by Asli.Tech</a>
    <a href="/license.txt" target="_blank">SOUNDIO Music App License</a>
</footer>

</body>
</html>
